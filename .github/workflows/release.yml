name: Release

permissions:
  id-token: write
  contents: write

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        with:
          version: 9.1.1

      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
          registry-url: https://registry.npmjs.org/

      - run: pnpm install

      - name: Detect changed packages
        id: changed-packages
        run: |
          CHANGED_PACKAGES=""
          
          for PKG in ./packages/*; do
            if [ -f "$PKG/package.json" ]; then
              PKG_PATH=$(echo "$PKG" | sed 's|^\./||')
              PKG_NAME=$(node -p "require('./$PKG_PATH/package.json').name")
              CURRENT_VERSION=$(node -p "require('./$PKG_PATH/package.json').version")
              
              LAST_RELEASE_COMMIT=$(git log --grep="release v" --format=%H -- "$PKG_PATH/package.json" | head -1)
              
              if [ -z "$LAST_RELEASE_COMMIT" ]; then
                LAST_RELEASE_COMMIT=$(git log --grep="release" --format=%H -- "$PKG_PATH/package.json" | head -1)
              fi
              
              if [ -n "$LAST_RELEASE_COMMIT" ]; then
                OLD_VERSION=$(git show "$LAST_RELEASE_COMMIT:$PKG_PATH/package.json" 2>/dev/null | grep '"version"' | head -1 | sed 's/.*"version": *"\([^"]*\)".*/\1/' || echo "")
                
                if [ -n "$OLD_VERSION" ] && [ "$OLD_VERSION" != "$CURRENT_VERSION" ]; then
                  CHANGED_PACKAGES="$CHANGED_PACKAGES $PKG_PATH|$PKG_NAME|$CURRENT_VERSION"
                  COMMIT_MSG=$(git log -1 --format=%s "$LAST_RELEASE_COMMIT")
                  echo "✅ Detected version change in $PKG_NAME: $OLD_VERSION -> $CURRENT_VERSION"
                  echo "   Last release commit: $LAST_RELEASE_COMMIT ($COMMIT_MSG)"
                fi
              else
                FIRST_COMMIT=$(git log --reverse --format=%H -- "$PKG_PATH/package.json" | head -1)
                if [ -n "$FIRST_COMMIT" ]; then
                  FIRST_VERSION=$(git show "$FIRST_COMMIT:$PKG_PATH/package.json" 2>/dev/null | grep '"version"' | head -1 | sed 's/.*"version": *"\([^"]*\)".*/\1/' || echo "")
                  if [ -n "$FIRST_VERSION" ] && [ "$FIRST_VERSION" != "$CURRENT_VERSION" ]; then
                    CHANGED_PACKAGES="$CHANGED_PACKAGES $PKG_PATH|$PKG_NAME|$CURRENT_VERSION"
                    echo "✅ Detected version change in $PKG_NAME: $FIRST_VERSION -> $CURRENT_VERSION (first commit with package.json)"
                  fi
                fi
              fi
            fi
          done
          
          if [ -n "$CHANGED_PACKAGES" ]; then
            echo "packages<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_PACKAGES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        if: steps.changed-packages.outputs.has_changes == 'true'
        run: pnpm dlx changelogithub
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        continue-on-error: true

      - name: Build packages
        if: steps.changed-packages.outputs.has_changes == 'true'
        run: pnpm build

      - name: Install dependencies
        if: steps.changed-packages.outputs.has_changes == 'true'
        run: pnpm -r install

      - name: Publish changed packages and create releases
        if: steps.changed-packages.outputs.has_changes == 'true'
        run: |
          PACKAGES_LIST="${{ steps.changed-packages.outputs.packages }}"
          
          echo "$PACKAGES_LIST" | tr ' ' '\n' | while IFS= read -r PKG_INFO; do
            if [ -z "$PKG_INFO" ]; then
              continue
            fi
            
            PKG_PATH=$(echo "$PKG_INFO" | cut -d'|' -f1)
            PKG_NAME=$(echo "$PKG_INFO" | cut -d'|' -f2)
            PKG_VERSION=$(echo "$PKG_INFO" | cut -d'|' -f3)
            
            if [ -f "./$PKG_PATH/package.json" ]; then
              echo "⚡ Processing $PKG_NAME v$PKG_VERSION"
              
              cd "./$PKG_PATH"
              
              echo "   Publishing to npm..."
              pnpm publish --no-git-checks --access public || true
              
              echo "   Creating GitHub release..."
              TAG_NAME="${PKG_NAME//\//-}@${PKG_VERSION}"
              TAG_NAME="${TAG_NAME//@/@}"
              
              LAST_RELEASE_COMMIT=$(git log --grep="release v" --format=%H -- . 2>/dev/null | head -1)
              if [ -z "$LAST_RELEASE_COMMIT" ]; then
                LAST_RELEASE_COMMIT=$(git log --grep="release" --format=%H -- . 2>/dev/null | head -1)
              fi
              
              if [ -n "$LAST_RELEASE_COMMIT" ]; then
                COMMITS=$(git log --reverse --format=%H ${LAST_RELEASE_COMMIT}..HEAD -- . 2>/dev/null | head -50)
              else
                COMMITS=$(git log --reverse --format=%H HEAD~10..HEAD -- . 2>/dev/null | head -50)
              fi
              
              RELEASE_NOTES="## Cambios\n\n"
              if [ -n "$COMMITS" ]; then
                RELEASE_NOTES+="### Commits\n\n"
                for COMMIT in $COMMITS; do
                  MSG=$(git log -1 --format=%s $COMMIT 2>/dev/null)
                  AUTHOR=$(git log -1 --format=%an $COMMIT 2>/dev/null)
                  RELEASE_NOTES+="- $MSG (@$AUTHOR)\n"
                done
              else
                RELEASE_NOTES+="Release $PKG_NAME v$PKG_VERSION"
              fi
              
              IS_PRERELEASE="false"
              if echo "$PKG_VERSION" | grep -qE "(alpha|beta|rc)"; then
                IS_PRERELEASE="true"
              fi
              
              ESCAPED_NOTES=$(echo "$RELEASE_NOTES" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
              
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Content-Type: application/json" \
                -d "{
                  \"tag_name\": \"$TAG_NAME\",
                  \"name\": \"$PKG_NAME v$PKG_VERSION\",
                  \"body\": \"$ESCAPED_NOTES\",
                  \"target_commitish\": \"${{ github.sha }}\",
                  \"draft\": false,
                  \"prerelease\": $IS_PRERELEASE
                }" \
                "https://api.github.com/repos/${{ github.repository }}/releases" \
                || echo "Release may already exist"
              
              cd ../..
            fi
          done
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
          NPM_CONFIG_PROVENANCE: true
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
